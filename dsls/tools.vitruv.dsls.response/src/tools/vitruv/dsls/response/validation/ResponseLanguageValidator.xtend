/*
 * generated by Xtext 2.9.0
 */
package tools.vitruv.dsls.response.validation

import org.eclipse.xtext.validation.Check
import tools.vitruv.dsls.response.responseLanguage.ResponseLanguagePackage
import java.util.HashMap
import static extension tools.vitruv.dsls.response.helper.ResponseClassNamesGenerator.*;
import tools.vitruv.dsls.response.responseLanguage.Routine
import tools.vitruv.dsls.response.responseLanguage.RoutineInput
import tools.vitruv.dsls.response.responseLanguage.RetrieveModelElement
import tools.vitruv.dsls.response.responseLanguage.CreateModelElement
import tools.vitruv.dsls.response.responseLanguage.Reaction
import tools.vitruv.dsls.response.responseLanguage.ReactionsSegment

/**
 * This class contains custom validation rules. 
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
class ResponseLanguageValidator extends AbstractResponseLanguageValidator {

	@Check
	def checkResponseFile(ReactionsSegment reactionsSegment) {
		val alreadyCheckedResponses = new HashMap<String, Reaction>();
		for (reaction : reactionsSegment.reactions) {
			val reactionName = reaction.reactionClassNameGenerator.simpleName;
			if (alreadyCheckedResponses.containsKey(reactionName)) {
				val errorMessage = "Duplicate reaction name: " + reactionName;
				error(errorMessage, reaction, ResponseLanguagePackage.Literals.REACTION__NAME);
				error(
					errorMessage,
					alreadyCheckedResponses.get(reactionName),
					ResponseLanguagePackage.Literals.REACTION__NAME
				);
			}
			alreadyCheckedResponses.put(reactionName, reaction);
		}
		val alreadyCheckedRoutines = new HashMap<String, Routine>();
//		for (implicitRoutine : reactionSegment.reactions.map[routine]) {
//			alreadyCheckedEffects.put(implicitRoutine.routineClassNameGenerator.simpleName, implicitRoutine);
//		}
		for (routine : reactionsSegment.routines) {
			val routineName = routine.routineClassNameGenerator.simpleName
			if (alreadyCheckedRoutines.containsKey(routineName)) {
				val errorMessage = "Duplicate effect name: " + routineName;
				error(errorMessage, routine, ResponseLanguagePackage.Literals.ROUTINE__NAME);
				val duplicateNameRoutine = alreadyCheckedRoutines.get(routineName);
				error(errorMessage, duplicateNameRoutine, ResponseLanguagePackage.Literals.ROUTINE__NAME);
			}
			alreadyCheckedRoutines.put(routineName, routine);
		}
	}

	@Check
	def checkRetrieveElementName(RetrieveModelElement element) {
		if (!element.name.nullOrEmpty && element.name.startsWith("_")) {
			error("Element names must not start with an underscore.",
				ResponseLanguagePackage.Literals.RETRIEVE_MODEL_ELEMENT__NAME);
		}
	}
	
		@Check
	def checkCreateElementName(CreateModelElement element) {
		if (!element.name.nullOrEmpty && element.name.startsWith("_")) {
			error("Element names must not start with an underscore.",
				ResponseLanguagePackage.Literals.CREATE_MODEL_ELEMENT__NAME);
		}
	}

//	@Check
//	def checkEffects(Effect effect) {
//		if (effect.impact.codeBlock == null && !effect.impact..filter(CorrespondingModelElementCreate).nullOrEmpty) {
//			warning("Created elements must be initialized and inserted into the target model in the execute block.",
//				ResponseLanguagePackage.Literals.EFFECT__CODE_BLOCK);
//		}
//	}
	
	@Check
	def checkEffectInput(RoutineInput effectInput) {
		if (!effectInput.javaInputElements.empty) {
			warning("Using plain Java elements is discouraged. Try to use model elements and make list inputs to single valued input of other effect that is called for each element.",
				ResponseLanguagePackage.Literals.ROUTINE_INPUT__JAVA_INPUT_ELEMENTS);
		}
	}
	
	@Check
	def checkRoutine(Routine routine) {
		if (!Character.isLowerCase(routine.name.charAt(0))) {
			warning("Routine names should start lower case",
				ResponseLanguagePackage.Literals.ROUTINE__NAME);
		}
	}
	
	@Check
	def checkRoutine(Reaction reaction) {
		if (!Character.isUpperCase(reaction.name.charAt(0))) {
			warning("Response names should start upper case",
				ResponseLanguagePackage.Literals.REACTION__NAME);
		}
	}

}
